@using Tops.FRM;
@{
    ViewBag.Title = "新增申请单";
    ViewBag.ModuleName = "新增申请单";
    Layout = "../../TopsLib/Views/Shared/_Layout.cshtml";
    var UserNo = Tops.FRM.TopsUser.UserNO;
}

<html>

<head>
    <title>新增申请单</title>
    <style>
        /*禁止这个页面内容被选中*/
        body
        {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            font-family: 微软雅黑;
        }
        /*主容器*/
        .main
        {
            width: 100%;
            max-width: 100%;
            font-weight: bold;
            margin: 0 auto;
        }
        /*头部*/
        .top
        {
            width: 95%;
            height: 110px;
            margin: auto;
        }

        .top_centre
        {
            width: 100%;
            float: left;
            height: 100%;
            font-size: 20px;
        }

            .top_centre > div
            {
                height: 100%;
                float: left;
            }

        /*模具【开始】*/
        .yj
        {
            border-top-right-radius: 10px;
            border-top-left-radius: 10px;
            border-bottom-right-radius: 10px;
            border-bottom-left-radius: 10px;
            width: 70%;
            height: 35px;
            font-size: 20px;
        }

        .yj1
        {
            border-top-right-radius: 10px;
            border-top-left-radius: 10px;
            border-bottom-right-radius: 10px;
            border-bottom-left-radius: 10px;
            width: 72%;
            font-size: 20px;
            height: 78px;
        }

        input
        {
            outline: medium;
        }

        /*模具【结束】*/
        .bot
        {
            width: 95%;
            height: 580px;
            margin: auto;
            margin-top: 10px;
        }

        .l_qx_divone
        {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            height: 180px;
            border: 3px solid #0072ffc7;
        }

        .l_qx_div
        {
            height: 165px;
            font-weight: bold;
            width: 86%;
            overflow: hidden;
        }

        .l_qx_div1
        {
            margin-top: 10px;
            font-weight: 100;
            height: 350px;
            border: 3px solid #0072ffc7;
            overflow-y: auto;
        }


            .l_qx_div1::-webkit-scrollbar
            { /*滚动条整体样式*/
                width: 40px; /*高宽分别对应横竖滚动条的尺寸*/
                height: 1px;
            }

            .l_qx_div1::-webkit-scrollbar-thumb
            { /*滚动条里面小方块*/
                border-radius: 40px;
                -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
                background: #535353;
            }

            .l_qx_div1::-webkit-scrollbar-track
            { /*滚动条里面轨道*/
                -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
                border-radius: 40px;
                background: #EDEDED;
            }

        /*打印【结束】*/

        .div_d1
        {
            height: 100px;
            width: 49.8%;
            float: left;
            overflow: hidden;
        }

        ul, li
        {
            list-style: none;
        }

        .cp_div
        {
            margin-top: 1%;
            list-style: none;
            padding: 2px;
            font-size: 13px;
            text-align: center;
            height: 130px;
            margin-left: 1%;
            float: left;
            padding-left: 1%;
            padding-right: 1%;
            border: 1px solid rgb(0, 0, 0);
            color: #232323;
            background-color: #fff;
            border-top-right-radius: 5px;
            border-top-left-radius: 5px;
            border-bottom-right-radius: 5px;
            border-bottom-left-radius: 5px;
        }

        .cpxz_div
        {
            color: #000;
            background-color: rgb(255, 246, 143);
            margin-top: 1%;
            list-style: none;
            padding: 2px;
            font-size: 13px;
            text-align: center;
            height: 130px;
            margin-left: 1%;
            float: left;
            padding-left: 1%;
            padding-right: 1%;
            border: 1px solid rgb(0, 0, 0);
            border-top-right-radius: 5px;
            border-top-left-radius: 5px;
            border-bottom-right-radius: 5px;
            border-bottom-left-radius: 5px;
        }

        .qx_List_div2
        {
            overflow-y: auto;
        }


            .qx_List_div2::-webkit-scrollbar
            { /*滚动条整体样式*/
                width: 40px; /*高宽分别对应横竖滚动条的尺寸*/
                height: 1px;
            }

            .qx_List_div2::-webkit-scrollbar-thumb
            { /*滚动条里面小方块*/
                border-radius: 40px;
                -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
                background: #535353;
            }

            .qx_List_div2::-webkit-scrollbar-track
            { /*滚动条里面轨道*/
                -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
                border-radius: 40px;
                background: #EDEDED;
            }

        .qx_List_div2_li
        {
            margin-top: 1%;
            list-style: none;
            padding: 2px;
            font-size: 33px;
            text-align: center;
            height: 55px;
            margin-left: 1%;
            float: left;
            padding-left: 1%;
            padding-right: 1%;
            border: 1px solid rgb(0, 0, 0);
            color: red;
            background-color: #87CEFA;
            border-top-right-radius: 5px;
            border-top-left-radius: 5px;
            border-bottom-right-radius: 5px;
            border-bottom-left-radius: 5px;
        }

        .qx_List_div2_li_xz
        {
            margin-top: 1%;
            list-style: none;
            padding: 2px;
            font-size: 33px;
            text-align: center;
            height: 55px;
            margin-left: 1%;
            float: left;
            padding-left: 1%;
            padding-right: 1%;
            border: 1px solid rgb(0, 0, 0);
            color: #131212;
            background-color: #fbe800;
            border-top-right-radius: 5px;
            border-top-left-radius: 5px;
            border-bottom-right-radius: 5px;
            border-bottom-left-radius: 5px;
        }

        #qx_ok
        {
            width: 250px;
            color: #000;
            background: rgb(255, 246, 143);
            border: 1px solid #000;
            font-size: 30px;
            text-align: center;
            margin-right: 30px;
        }

        #qx_no
        {
            width: 250px;
            color: #000;
            background: rgb(255, 246, 143);
            border: 1px solid #000;
            font-size: 30px;
            text-align: center;
            margin-right: 30px;
        }

        #dy_List
        {
            width: 67%;
            height: 74%;
            top: 14%;
            left: 10px;
            display: none;
            background: #fff;
            z-index: 8886;
            position: absolute;
            border: 2px solid #000;
        }

        #qx_List
        {
            top: 9%;
            left: 9%;
            width: 80%;
            height: 80%;
            display: none;
            background: #fff;
            z-index: 8886;
            position: absolute;
            border: 2px solid #000;
        }

        .div_zxHao
        {
            height: 46px;
            font-size: 40px;
            width: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

            .div_zxHao > span
            {
                margin-left: 30PX;
                font-size: 21px;
                width: 35%;
            }

        .div_zxHaoone
        {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            height: 90px;
            width: 100%;
            text-align: center;
        }

        table
        {
            border-collapse: collapse;
            border-spacing: 0;
        }

        td, th
        {
            padding: 0;
        }

        .pure-table
        {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            empty-cells: show;
            border: 1px solid #cbcbcb;
        }

            .pure-table caption
            {
                color: #000;
                font: italic 85%/1 arial,sans-serif;
                padding: 1em 0;
                text-align: center;
            }

            .pure-table td, .pure-table th
            {
                border-left: 1px solid #cbcbcb;
                border-width: 0 0 0 1px;
                font-size: inherit;
                margin: 0;
                overflow: visible;
                padding: .5em 1em;
            }

            .pure-table thead
            {
                font-size: 12px;
                background-color: #e0e0e0;
                color: #000;
                text-align: left;
                vertical-align: bottom;
            }

        #Tables
        {
            font-size: 12px;
            color: #000;
        }

        .pure-table td
        {
            background-color: transparent;
            border: 1px solid #cbcbcb;
        }

        .button
        {
            background-color: #0072ffc7; /* Green */
            border-radius: 10px;
            border: none;
            color: white;
            padding: 20px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            -webkit-transition-duration: 0.4s; /* Safari */
            transition-duration: 0.4s;
        }

        .button3
        {
            background: #DDDDDD; /* Green */
            border-radius: 10px;
            border: none;
            color: #000;
            padding: 20px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            -webkit-transition-duration: 0.4s; /* Safari */
            transition-duration: 0.4s;
        }

        .button2:hover
        {
            box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24),0 17px 50px 0 rgba(0,0,0,0.19);
        }

        #div_List2_dialog
        {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #000;
            filter: alpha(Opacity=50);
            -moz-opacity: 0.3;
            opacity: 0.5;
            z-index: 5000;
        }

        #QianPrint
        {
            margin-left: 10px;
            width: 13%;
        }
    </style>
    <style media="screen and (max-width: 900px) ">
        .top_centre
        {
            font-size: 12px;
        }

        .div_d1
        {
            height: 100px;
            width: 99.8%;
            overflow: hidden;
        }

        .div_zxHao > span
        {
            margin-left: 5PX;
            font-size: 15px;
            width: 26%;
        }

        .div_zxHao > .yj
        {
            margin-left: 10PX;
        }

        #QianPrint
        {
            font-size: 10px;
            margin-left: 10px;
            width: 18%;
        }

        .l_qx_div1
        {
            height: 250px;
        }
    </style>
</head>
<body>
    <div id="div_List2_dialog" style="display: none;"></div>
    <div style="border: 2px solid #232323; height: 839px;">
        <div class="top">
            <div class="top_centre">
                <div class="top_centre_OperType" style="width: 60%; padding: 10px 0px;">
                    <div style="float: left; height: 40%; width: 50%">
                        <span style="font-weight: bold;">产品名称：</span>
                        <span style="color: #0072ffc7;" id="s_Name"></span>
                    </div>
                    <div style="float: left; height: 45%; width: 50%">
                        <span style="font-weight: bold;">客户料号：</span>
                        <span style="color: #0072ffc7;" id="Product_Label"></span>
                    </div>
                    <div style="float: left; height: 45%; width: 25%">
                        <span style="font-weight: bold;">计划数量：</span>
                        <span style="color: #0072ffc7;" id="n_Num"></span>
                    </div>
                    <div style="float: left; height: 35%; width: 25%">
                        <span style="font-weight: bold;">累&nbsp;计&nbsp;数：</span>
                        <span style="color: #0072ffc7;" id="CLnum">0</span>
                    </div>
                    <div style="float: left; height: 40%; width: 50%">
                        <span style="font-weight: bold;">批&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;次：</span>
                        <span style="color: #0072ffc7;" id="Batch"></span>
                    </div>
                </div>

                <div style="float: left; width: 10%; display: flex; justify-content: flex-start; align-items: center;">
                    <button id="fxBox" class="button button2">封&nbsp;&nbsp;&nbsp;&nbsp;箱</button>
                </div>

                <div style="float: left; font-weight: bold; line-height: 45px; text-align: right; width: 30%; color: black;">
                    <div>当前用户:&nbsp;<span style="color: #0072ffc7" class="userName">@UserNo</span></div>
                    <div style="color: #0072ffc7"><span id="sp_date">2018/3/15</span>&nbsp;&nbsp;<span id="sp_time">11:52:15</span></div>
                </div>
            </div>
        </div>
        <div class="div_List1" style="width: 98%; border: 2px solid #232323; margin: 1px auto;">
            <div class="main">
                <div id="mjxz" style="width: 95%; height: 92px; margin: 10px auto;">
                    <div class="div_d1">
                        <div class="div_zxHaoone">
                            <button id="HouPrint" style="height: 80px; width: 26%" class="button3">
                                后件装箱单号
                            </button>
                            <input type="text" id="ZXhao" style="margin-left: 15px;" class="yj1" title="后箱号" autocomplete="off" />
                        </div>
                    </div>
                    <div class="div_d1">
                        <div class="div_zxHao">
                            <span class="spanHao">请扫描装箱单号:</span>
                            <input type="text" id="ZXhaoOne" class="yj" title="请扫描装箱单号" placeholder="请扫描装箱单号" autocomplete="off" />
                        </div>
                        <div class="div_zxHao">
                            <span class="spanHao1">请扫描前箱工件标签:</span>
                            <input type="text" id="ZXhaoTwo" class="yj" title="请扫描前箱工件标签" placeholder="请扫描前箱工件标签" autocomplete="off" />
                        </div>
                    </div>
                </div>
                <div class="bot">
                    <div class="l_qx_divone">
                        <div class="l_qx_div"></div>
                        <button id="QianPrint" class="button button2">
                            &nbsp; 前&nbsp;箱&nbsp;完&nbsp;成&nbsp;
                        </button>
                    </div>
                    <div class="l_qx_div1">
                        <table class="pure-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%; text-align: center">#</th>
                                    <th style="width: 20%">前箱工件标签</th>
                                    <th style="width: 15%">产品编号</th>
                                    <th style="width: 20%">后箱号</th>
                                    <th style="width: 10%">质量状态</th>
                                    <th style="width: 10%">更新人</th>
                                    <th style="width: 20%">更新时间</th>
                                </tr>
                            </thead>
                            <tbody id="Tables">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="qx_List">
                <div class="qx_List_div2" style="border: 2px solid #0072ffc7; height: 80%; margin: 5px">
                </div>
                <div style="height: 20%; display: flex; justify-content: flex-end; flex-wrap: nowrap">
                    <div style="width: 40%; height: 90%; display: flex; justify-content: center; align-items: center">
                        <button id="qx_ok" class="button button2">确&nbsp;&nbsp;&nbsp;&nbsp;定</button>
                        <button id="qx_no" class="button button2">取&nbsp;&nbsp;&nbsp;&nbsp;消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script src="../../TopsLib/Scripts/tFronQueentJs.js"></script>
<script type="text/javascript">

    $(function () {
        $("#ZXhao").focus().val();
        reloop();  //日期显示
        LoadBacth(); //获取批次
        onDelete(); // 加载缺陷
    })

    // 获取后装箱单号回车事件
    $("#ZXhao").keydown(function (e) {
        if (e.keyCode == 13) {
            var HouBarcode = $("#ZXhao").val();    // 后箱装箱单 1 
            var Batch = HouBarcode.substring(HouBarcode.indexOf("$") + 1, HouBarcode.indexOf("$") + 7);
            var Label = HouBarcode.substring(0, HouBarcode.indexOf("$"));
            //var ToLabel = HouBarcode.substring(HouBarcode.length - 10, HouBarcode.length);
            var sBatch = $("#Batch").html().trim();

            if (HouBarcode == "") {
                alertN("后装箱单不能为空！");
                $("#ZXhao").val("");
                $("#ZXhao").focus().val();
                return;
            }

            if (HouBarcode.indexOf("$") == -1) {
                alertN("后装箱单没有存在$这个字符！");
                $("#ZXhao").val("");
                $("#ZXhao").focus().val();
                return
            }

            if (HouBarcode.trim().length <= 14) {
                alertN("后箱装箱单不能小于14位！");
                $("#ZXhao").val("");
                $("#ZXhao").focus("").val();
                return;
            }

            if (Label.indexOf("-") == -1) {
                alertN("后装箱单没有存在 - 这个字符！");
                $("#ZXhao").val("");
                $("#ZXhao").focus().val();
                return
            }


            //if (!num(ToLabel)) {
            //    alertN("后箱批次流水码必须是纯数字！");
            //    $("#ZXhao").val("");
            //    $("#ZXhao").focus().val();
            //    return
            //}

            $.topsAjax({
                type: "GET",
                data: { tts: 1, HouBarcode: HouBarcode, Batch: Batch, Label: Label.substring(0, Label.indexOf("-")) },
                url: "/AjaxGet/SelIsHouBarCode",
                success: function (data) {
                    if (data.Data[0].length > 0) {
                        $("#Product_Label").html(data.Data[0][0].s_Product_Label);
                        $("#s_Name").html(data.Data[0][0].s_Product_Name);
                        $("#ZXhao").attr("disabled", "disabled");

                        if (data.Data[0][0].isOrigin == "2") {
                            $("#ZXhaoOne").val(data.Data[0][0].s_Qian_Label);
                            $("#ZXhaoOne").attr("disabled", "disabled");
                            $("#HouPrint").css({ "background": "#87CEFA" })
                            LoadQianBox(HouBarcode);
                        } else {
                            LoadQianBox(HouBarcode);
                        }
                    } else {
                        $("#ZXhao").val("");
                        $("#ZXhao").focus().val();
                        alertN("该装箱单已封箱，不能在进行扫描！");
                    }
                }
            })
        }
    });

    // 获取前装箱单号回车事件
    $("#ZXhaoOne").keydown(function (e) {
        if (e.keyCode == 13) {
            var HouBarcode = $("#ZXhao").val();    // 后箱装箱单
            var QianBarcode = $("#ZXhaoOne").val();    // 前箱装箱单
            var Label = QianBarcode.substring(0, QianBarcode.indexOf("$"));
            //var ToLabel = QianBarcode.substring(QianBarcode.length - 10, QianBarcode.length);
            var sBatch = $("#Batch").html().trim();

            if (QianBarcode == "") {
                alertN("前装箱单号不能为空！");
                $("#ZXhaoOne").val("");
                $("#ZXhaoOne").focus().val();
                return;
            }

            if (QianBarcode.indexOf("$") == -1) {
                alertN("前装箱单号没有存在$这个字符！");
                $("#ZXhaoOne").val("");
                $("#ZXhaoOne").focus().val();
                return
            }

            if (Label != HouBarcode.substring(0, HouBarcode.indexOf("-"))) {
                alertN("前装箱单号和后装箱单号不相同,请重新扫码！");
                $("#ZXhaoOne").val("");
                $("#ZXhaoOne").focus().val();
                return;
            }

            if ($("#ZXhao").attr("disabled") == undefined) {
                alertN("请确认后装箱单！");
                $("#ZXhaoOne").val("");
                $("#ZXhao").focus().val();
                return;
            }

            //if (!num(ToLabel)) {
            //    alertN("前箱批次流水码必须是纯数字！");
            //    $("#ZXhaoOne").val("");
            //    $("#ZXhaoOne").focus().val();
            //    return
            //}

            $.topsAjax({
                type: "GET",
                data: {
                    tts: 1,
                    HouBarcode: HouBarcode, QianBarcode: QianBarcode,
                    sBatch: sBatch, Label: Label
                },
                url: "/AjaxGet/SelIsQianBarCode",
                success: function (data) {
                    if (data.Data.length > 0) {
                        $("#ZXhaoOne").attr("disabled", "disabled");
                        $("#HouPrint").css({ "background": "#87CEFA" })
                        LoadQianBox(HouBarcode);
                    } else {
                        $("#ZXhaoOne").val("");
                        $("#ZXhaoOne").focus().val();
                        alertN("该前箱装箱单已录入，不能重复录入！");
                    }
                }
            })
        }
    });

    // 获取前箱工件标签
    $("#ZXhaoTwo").keydown(function (e) {
        if (e.keyCode == 13) {
            var HouBarcode = $("#ZXhao").val();        // 后箱装箱单
            var QianBarcode = $("#ZXhaoOne").val();    // 前箱装箱单
            var Barcode = $("#ZXhaoTwo").val();        // 前箱工件标签
            var Label = Barcode.substring(0, Barcode.indexOf("$"));
            //var ToLabel = Barcode.substring(Barcode.length - 10, Barcode.length);
            var sBatch = $("#Batch").html().trim();    // 当前批次


            if (Barcode == "") {
                alertN("请先扫描前箱工件标签！");
                $("#ZXhaoTwo").val("");
                $("#ZXhaoTwo").focus().val();
                return;
            }

            if (Label != HouBarcode.substring(0, HouBarcode.indexOf("-"))) {
                alertN("前装箱单号和工件标签不相同,请重新扫码！");
                $("#ZXhaoTwo").val("");
                $("#ZXhaoTwo").focus().val();
                return;
            }

            if ($("#ZXhaoOne").attr("disabled") == undefined) {
                alertN("请确认前箱装箱单！");
                $("#ZXhaoOne").focus().val();
                return;
            }

            //if (!num(ToLabel)) {
            //    alertN("前箱标签批次流水码必须是纯数字！");
            //    $("#ZXhaoTwo").val("");
            //    $("#ZXhaoTwo").focus().val();
            //    return
            //}

            $.topsAjax({
                type: "GET",
                data: {
                    tts: 2,
                    Barcode: Barcode
                },
                url: "/AjaxGet/SelIsHouNumber",
                success: function (data) {
                    if (data.Data[0][0].num == 0) {
                        $.topsAjax({
                            type: "Post",
                            url: "/AjaxPost/AddIsHouCodeList",
                            data: { Barcode: Barcode, QianBarcode: QianBarcode, Label: Label, sBatch: sBatch, HouBarcode: HouBarcode },
                            success: function (Addnum) {
                                if (Addnum.IsSuccess) {
                                    $("#ZXhaoTwo").val("");
                                    $("#ZXhaoTwo").focus().val();
                                    if (Addnum.OutPut.QualityNum == "0") {
                                        alertN("已达到标准装箱数量，请确认封箱！！");
                                        $.topsAjax({
                                            type: "GET",
                                            data: {
                                                tts: 3,
                                                HouBarcode: HouBarcode
                                            },
                                            url: "/AjaxGet/SelIsHouBarCode",
                                            success: function (data) {
                                                if (data.IsSuccess) {
                                                    if (data.Data.length > 0) {
                                                        alertN("封箱完成！！");
                                                        setTimeout("location.reload()", 2000);
                                                    }
                                                }
                                            }
                                        })
                                    } else {
                                        LoadQianBox(HouBarcode);
                                    }
                                }
                            }
                        })
                    } else {
                        alertN("存在相同前箱工件标签！");
                        $("#ZXhaoTwo").val("");
                        $("#ZXhaoTwo").focus().val();

                    }
                }
            })
        }
    });

    // 加载后箱累计数
    function HouNumber() {
        var HouBarcode = $("#ZXhao").val();

        $.topsAjax({
            type: "GET",
            data: {
                tts: 1,
                HouBarcode: HouBarcode
            },
            url: "/AjaxGet/SelIsHouNumber",
            success: function (data) {
                if (data.Data.length > 0) {
                    $("#CLnum").html(" " + data.Data[0][0].OKNum + " / " + data.Data[0][0].ZongNum + " ");
                }
            }
        })
    }

    // 加载前箱
    function LoadQianBox(HouBarcode) {
        $.topsAjax({
            type: "GET",
            data: {
                tts: 2, HouBarcode: HouBarcode
            },
            url: "/AjaxGet/SelIsQianBarCode",
            success: function (data) {
                if (data.IsSuccess) {
                    $(".l_qx_div").html("");
                    var htmls = "";
                    for (var i = 0; i < data.Data[0].length; i++) {
                        if (data.Data[0][i].n_IsPrint == 2) {
                            htmls += '<li class="cp_div cpxz_div"  QianID="' + data.Data[0][i].s_QianID
                              + '";  onclick="onCompleted()"; >本箱产品客户料号：' + data.Data[0][i].s_Client_PartNo
                              + '<br /><br />前箱已用数：<span class="alrspana">'
                                + data.Data[0][i].ZongNum + '</span><br /><br />【合格 '
                                + data.Data[0][i].OKNum + ' / 不合格 '
                                + data.Data[0][i].NoNum + '】'
                                + ' <br /><br />' + data.Data[0][i].d_Creatime + '</li>';
                        } else {
                            htmls += '<li class="cp_div" QianID="' + data.Data[0][i].s_QianID
                                + '"  >本箱产品客户料号：' + data.Data[0][i].s_Client_PartNo + '<br /><br />前箱已用数：<span class="alrspana">'
                                + data.Data[0][i].ZongNum + '</span><br /><br />【合格 '
                                + data.Data[0][i].OKNum + ' / 不合格 '
                                + data.Data[0][i].NoNum + '】'
                                + ' <br /><br />' + data.Data[0][i].d_Creatime + '</li>';
                        }
                    }

                    $(".l_qx_div").prepend(htmls);
                    $(".spanHao").html("装箱单号:");
                    $(".spanHao").css("color", "#0072ffc7");
                    $(".spanHao1").html("前箱工件标签:");
                    $(".spanHao1").css("color", "#0072ffc7");

                    LoadHouLog(HouBarcode);
                }
            }
        })
    }

    // 加载后箱详细信息
    function LoadHouLog(HouBarcode) {
        $.topsAjax({
            type: "GET",
            data: { tts: 2, HouBarcode: HouBarcode },
            url: "/AjaxGet/SelIsHouBarCode",
            success: function (data) {
                $("table #Tables").html("");
                var tr = ""
                for (var i = 0; i < data.Data[0].length; i++) {
                    if (data.Data[0][i].N_QualityState == "待定") {
                        tr += "<tr style='background:#99CCFF;'><td  style='text-align:center'>" + (i + 1)
                      + "</td><td>" + data.Data[0][i].s_Qian_Label
                      + "</td><td>" + data.Data[0][i].s_CurdeCode
                      + "</td><td>" + data.Data[0][i].s_Client_PackNo
                      + "</td><td>" + data.Data[0][i].N_QualityState
                      + "</td><td>" + data.Data[0][i].s_Updator
                      + "</td><td>" + data.Data[0][i].d_Updatime
                      + "</td></tr>"
                    } else {
                        tr += "<tr><td  style='text-align:center'>" + (i + 1)
                      + "</td><td>" + data.Data[0][i].s_Qian_Label
                      + "</td><td>" + data.Data[0][i].s_CurdeCode
                      + "</td><td>" + data.Data[0][i].s_Client_PackNo
                      + "</td><td>" + data.Data[0][i].N_QualityState
                      + "</td><td>" + data.Data[0][i].s_Updator
                      + "</td><td>" + data.Data[0][i].d_Updatime
                      + "</td></tr>"
                    }
                }
                $("#Tables").prepend(tr);
                HouNumber();   // 加载后箱累计数
            }
        })
    }

    // 加载缺陷
    function onDelete() {
        $.topsAjax({
            type: "GET",
            data: { tts: 1 },
            url: "/AjaxGet/SeltDeledeBoxLog",
            success: function (data) {
                $(".qx_List_div2").html("");
                var li = "";
                for (var i = 0; i < data.Data[0].length; i++) {
                    li += "<li class='qx_List_div2_li' s_DefectID='" + data.Data[0][i].s_DefectID + "'>" + data.Data[0][i].s_Defect + "</li>"
                }
                $(".qx_List_div2").append(li);
            }
        })
    }

    // 批次
    function LoadBacth() {
        var time = new Date();
        var year = time.getFullYear();
        var month = time.getMonth() + 1;
        var day = time.getDate();

        if (month < 10) {
            month = "0" + month;
        }
        if (day < 10) {
            day = "0" + day;
        }

        $("#Batch").html(year.toString().substring(2, 4) + month + day);

        setTimeout("LoadBacth()", 3000000);
    }

    //日期时间显示
    function reloop() {
        var time = new Date();
        var year = time.getFullYear();
        var month = time.getMonth() + 1;
        var day = time.getDate();
        var hour = time.getHours();
        var minute = time.getMinutes();
        var second = time.getSeconds();
        if (minute < 10) {
            minute = "0" + minute;
        }
        if (second < 10) {
            second = "0" + second;
        }
        $("#sp_date").html(year + "/" + month + "/" + day);
        $("#sp_time").html(hour + ":" + minute + ":" + second);
        setTimeout("reloop()", 1000);
    }

    //验证全是数字
    //function num(value) {
    //    var n = /^[0-9]*$/;
    //    var re = new RegExp(n);
    //    if (re.test(value)) {
    //        return true;
    //    }
    //    else {
    //        return false;
    //    }
    //}

    // 点击缺陷信息弹出
    function onCompleted() {
        var is = event.currentTarget;
        var Qianid = $(is).attr("qianid"); //获取当前元素，类同this

        $.topsAjax({
            type: "GET",
            data: { tts: 2, Qianid: Qianid },
            url: "/AjaxGet/SeltDeledeBoxLog",
            success: function (data) {
                if (data.IsSuccess) {
                    if (data.Data[0][0].num > 0) {
                        $("#qx_List").css({ "display": "block " })
                        $("#div_List2_dialog").css({ "display": "block " })
                    } else {
                        alertN("没有待定信息不能录入缺陷！！");
                    }
                }
            }
        })
    }

    // 缺陷取消按钮
    $("#qx_no").click(function () {
        $("#qx_List").css({ "display": "none " })
        $("#div_List2_dialog").css({ "display": "none " })
    })

    // 缺陷确认按钮
    $("#qx_ok").click(function () {
        var DefectID = $(".qx_List_div2_li_xz:eq(0)").attr("s_DefectID");
        var DefectName = $(".qx_List_div2_li_xz:eq(0)").html();
        var Qianid = $(".cpxz_div:eq(0)").attr("qianid");
        var HouBarcode = $("#ZXhao").val();

        if (DefectID == null) {
            alertN("请选择相应的缺陷！！");
            return;
        }

        $.topsAjax({
            type: "GET",
            data: { tts: 3, DefectID: DefectID, DefectName: DefectName, Qianid: Qianid },
            url: "/AjaxGet/SeltDeledeBoxLog",
            success: function (data) {
                if (data.IsSuccess) {
                    $("#qx_List").css({ "display": "none " })
                    $("#div_List2_dialog").css({ "display": "none " })
                    LoadQianBox(HouBarcode)
                }
            }
        })
    })

    //选择缺陷
    $(".qx_List_div2 li").live("click", function () {
        $(".qx_List_div2_li_xz").removeClass("qx_List_div2_li_xz");
        $(this).addClass("qx_List_div2_li_xz");
    });

    // 点击前箱完成
    $("#QianPrint").click(function () {
        var HouBarcode = $("#ZXhao").val();        // 后箱装箱单
        var QianBarcode = $("#ZXhaoOne").val();    // 前箱装箱单
        var sBatch = $("#Batch").html().trim();

        if ($("#ZXhaoOne").val().trim() == "") {
            alertN("前装箱单号不能为空！");
            $("#ZXhaoOne").val("");
            $("#ZXhaoOne").focus().val();
            return;
        }

        if ($("#ZXhaoOne").attr("disabled") == undefined) {
            alertN("请确认前箱装箱单！");
            $("#ZXhaoOne").focus().val();
            return;
        }

        $.topsAjax({
            type: "GET",
            data: {
                tts: 1,
                QianBarcode: QianBarcode,
                Batch: sBatch
            },
            url: "/AjaxGet/SelIsBarCodePrint",
            success: function (data) {
                if (data.IsSuccess) {
                    if (data.Data.length > 0) {
                        $("#ZXhaoOne").val("");
                        $("#ZXhaoOne").removeAttr("disabled");
                        $("#ZXhaoOne").focus().val();
                        LoadQianBox(HouBarcode);

                    } else {
                        alertN("该前箱没有存在后箱结果信息！！");
                    }
                }
            }
        })
    });

    // 封箱
    $("#fxBox").click(function () {
        var HouBarcode = $("#ZXhao").val();    // 后箱装箱单
        var QianBarcode = $("#ZXhaoOne").val();    // 前箱装箱单

        if (HouBarcode == "") {
            alertN("请扫描后箱装箱单！");
            return;
        }

        $.topsAjax({
            type: "GET",
            data: {
                tts: 3,
                HouBarcode: HouBarcode
            },
            url: "/AjaxGet/SelIsHouBarCode",
            success: function (data) {
                if (data.IsSuccess) {
                    if (data.Data.length > 0) {
                        alertN("封箱完成！！");
                        location.reload();
                    } else {
                        alertN("请扫描后箱工件标签！！");
                    }
                }
            }
        })
    })
</script>
